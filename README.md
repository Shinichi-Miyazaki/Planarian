# Animal Detector GUI

## 概要

このツールは、時系列撮影された画像から動物（背景より暗い領域）を自動検出し、重心位置・長軸・短軸・円形度・面積などの特徴量を測定します。昼夜の明るさ変化に対応した適応的二値化や、ROI指定、時系列グラフ表示など、研究用途に特化した機能を搭載しています。

## 必要な環境
- Python 3.8以降
- pip

### 必要なライブラリのインストール
```bash
pip install -r requirements.txt
```

または個別にインストール：
```bash
pip install opencv-python numpy pandas matplotlib Pillow scikit-image
```

**注意**: tkinterはPythonの標準ライブラリなので追加インストール不要です。

## 使い方

### 1. アプリケーションの起動
```bash
python animal_detector_gui.py
```

### 2. 基本設定
GUI画面で以下を設定してください：

#### 必須設定
- **画像フォルダ**: 解析したい画像が入っているフォルダを選択
- **昼の代表画像**: 明るい時間帯の代表的な画像を選択
- **夜の代表画像**: 暗い時間帯の代表的な画像を選択

#### パラメータ設定
- **最小面積**: 検出対象の最小面積（デフォルト: 100）
- **最大面積**: 検出対象の最大面積（デフォルト: 10000）

#### 二値化設定
- **メソッド**: adaptive（推奨）、relative、fixed から選択
- **相対閾値**: 相対閾値方式での閾値（0.0-1.0、デフォルト: 0.15）
- **ブロックサイズ**: 適応的二値化のブロックサイズ（奇数、デフォルト: 15）
- **定数C**: 適応的二値化の定数（デフォルト: 8）

#### 時間設定
- **昼開始時刻**: 昼の開始時刻（HH:MM形式、デフォルト: 07:00）
- **夜開始時刻**: 夜の開始時刻（HH:MM形式、デフォルト: 19:00）
- **測定開始時刻**: 実験開始時刻（HH:MM:SS形式、デフォルト: 09:00:00）

### 3. 高度な機能

#### ROI（関心領域）設定
1. 「ROI使用」にチェックを入れる
2. 「設定」ボタンを押す
3. 昼画像プレビューでマウスドラッグして領域を指定

#### Temporal Median Filter（背景除去）
1. 「使用」にチェックを入れる
2. フレーム数を設定（デフォルト: 100）
3. 「背景作成」ボタンで背景画像を生成

#### コントラスト調整
- **基本調整**: 倍率と明度を調整
- **CLAHE**: 局所適応ヒストグラム平坦化を使用

#### 動画保存
- 検出結果を動画として保存可能
- FPSとスケールを調整可能

### 4. プレビューと調整
「プレビュー更新」ボタンで昼・夜の代表画像での検出結果を確認し、パラメータを調整してください。

### 5. 解析実行
「解析開始」ボタンで全画像の自動解析を実行します。

## 出力ファイル

### CSV出力
- `analysis_results.csv`: 各画像の特徴量データ
  - centroid_x, centroid_y: 重心座標
  - major_axis, minor_axis: 長軸・短軸
  - circularity: 円形度
  - area: 面積
  - filename: ファイル名

### その他の出力
- `activity_graph.png`: 時系列活動グラフ
- `detection_video.avi`: 検出結果動画（有効化時）
- `time_config.json`: 時間設定ファイル

## 検出できない場合のトラブルシューティング

### 基本的な調整方法

#### 1. 二値化パラメータの調整
**症状**: 動物が検出されない、または背景のノイズが多い

**対策**:
- **相対閾値**を調整（0.1〜0.3の範囲で試す）
- **ブロックサイズ**を変更（11, 15, 21, 31など奇数値）
- **定数C**を調整（5〜15の範囲）
- **メソッド**を変更（adaptive → relative → fixed）

#### 2. 面積フィルタの調整
**症状**: 小さなノイズが検出される、または動物が大きすぎて除外される

**対策**:
- **最小面積**を大きくしてノイズを除去
- **最大面積**を調整して対象サイズに合わせる
- プレビューで実際の動物の面積を確認

#### 3. コントラスト調整の活用
**症状**: 画像が暗すぎる、明るすぎる

**対策**:
- **コントラスト強化**を有効にして倍率を調整（1.2〜2.0）
- **CLAHE**を有効にして局所コントラストを改善
- **明度調整**で全体の明るさを補正（-50〜+50）

#### 4. 背景除去の活用
**症状**: 背景の汚れや影が検出される

**対策**:
- **Temporal Median Filter**を使用して背景を除去
- **バックグラウンド除去**を有効にしてガウシアンブラーで背景を除去
- **BGカーネルサイズ**を調整（21, 31, 51など奇数値）

#### 5. ROI設定の活用
**症状**: 画像の端の不要な部分が検出される

**対策**:
- **ROI**で動物がいる領域のみに限定
- 水槽や実験容器の内部のみを指定

### 高度なトラブルシューティング

#### 個体選択の調整
- **Select Largest Particle**: 最大面積の個体を選択（複数検出時）
- **Constant Darkness**: 恒暗条件での実験時に使用

#### 時間設定の確認
- `timelog.txt`ファイルが正しく配置されているか確認
- 時刻フォーマットが正しいか確認（HH:MM:SS）

### 検出精度を上げるコツ

1. **代表画像の選択**: 典型的な明るさと動物の状態を示す画像を選ぶ
2. **段階的調整**: まず昼の画像で調整し、次に夜の画像で微調整
3. **プレビュー活用**: 各パラメータ変更後は必ずプレビューで確認
4. **ROI活用**: 動物がいる領域のみに限定して精度向上
5. **設定保存**: 良い設定が見つかったら「設定保存」で保存

## 特徴

- **適応的二値化**: 明るさ変化に自動対応
- **ROI指定**: 関心領域のみを解析
- **時系列グラフ**: 活動パターンの可視化
- **背景除去**: Temporal Median FilterやRolling Ball
- **コントラスト調整**: CLAHE、線形調整
- **リアルタイムプレビュー**: パラメータ調整の即座確認
- **設定保存/読み込み**: 実験設定の再利用
- **動画出力**: 検出過程の記録
- **マルチスレッド処理**: GUIブロックなし

## ライセンス
MIT License

## 更新履歴
- v2.0: ROI機能、Temporal Median Filter、コントラスト調整、時系列グラフ追加
- v1.0: 基本的な動物検出機能
