# 動物検出GUI - Planarian Analysis Tool

プラナリアなどの動物の活動を画像解析により自動検出・追跡するためのGUIアプリケーションです。

## 主要機能

### 1. ROI (Region of Interest) 機能
- **円形マスク対応**: ROI設定時に円形の領域を指定でき、その外側を完全にマスクして検出対象から除外します
- **設定方法**: 昼の代表画像プレビューでマウスドラッグにより円形ROIを設定
- **効果**: ROI外の物体が検出されることを防ぎ、目的の個体のみを正確に追跡できます

### 2. 夜間自動コントラスト調整
- **自動判定**: 画像の明度から夜間かどうかを自動判定（デフォルト閾値: 50）
- **夜間専用処理**: 夜間と判定された画像にのみコントラスト調整を適用
- **調整内容**: 
  - コントラスト倍率: 1.5倍
  - 明度調整: +10
  - CLAHE（局所適応ヒストグラム平坦化）: 有効

### 3. 二値化処理パラメータ

#### 適応的二値化 (Adaptive Thresholding)
- **block_size**: 近傍領域のサイズ（必ず奇数）
  - 小さい値（3-11）: 細かい特徴を検出、ノイズに敏感
  - 大きい値（15-31）: 大きな構造を検出、ノイズに強い
  - **推奨値**: 15（中程度のサイズの個体に適している）

- **c_value**: 定数C（平均値から引く値）
  - 小さい値（2-5）: より多くの領域が白になる（感度高）
  - 大きい値（8-15）: より少ない領域が白になる（感度低）
  - **推奨値**: 8（暗い個体の検出に最適化）

#### 相対閾値 (Relative Thresholding)
- **relative_thresh**: 平均輝度からの割合（0.0-1.0）
  - 0.1なら平均輝度の90%を閾値として使用
  - **推奨値**: 0.15（暗い個体に適している）

#### バックグラウンド除去
- **bg_kernel_size**: ガウシアンブラーのカーネルサイズ
  - 大きい値ほど広範囲の背景を除去
  - **推奨値**: 31（中程度の背景変動に対応）

### 4. 個体選択方法
- **Select Largest Particle**: 最大面積の個体を優先的に選択
- **中心に最も近い個体**: 画像中心に最も近い個体を選択
- **面積 + 中心距離**: 上位20%の大きさの個体の中から最も中心に近いものを選択

### 5. Temporal Median Filter
- **背景除去**: 複数フレームの中央値を使用して静的な背景を除去
- **フレーム数**: 背景作成に使用するフレーム数（推奨: 100）
- **効果**: 動的な個体のみを検出し、静的なノイズや背景の変化を排除

## 使用方法

### 基本的な解析手順
1. **画像フォルダ選択**: 解析対象の画像が含まれるフォルダを選択
2. **代表画像設定**: 昼と夜の代表的な画像を選択
3. **ROI設定**: 必要に応じて解析対象領域を円形で指定
4. **パラメータ調整**: 検出する個体の大きさに応じて最小・最大面積を設定
5. **プレビュー確認**: 昼・夜画像プレビューで検出結果を確認
6. **解析実行**: 「解析開始」ボタンで全画像の自動解析を実行

### パラメータ調整のコツ

#### 検出感度を上げたい場合
- `c_value`を小さくする（5-6）
- `relative_thresh`を大きくする（0.2-0.25）
- 最小面積を小さくする

#### ノイズを減らしたい場合
- `c_value`を大きくする（10-12）
- `block_size`を大きくする（19-25）
- 最小面積を大きくする
- バックグラウンド除去を有効にする

#### 夜間の検出を改善したい場合
- コントラスト調整を有効にする
- CLAHEを有効にする
- 夜間判定閾値を調整する（明るい夜間画像の場合は閾値を上げる）

### 出力ファイル
- `analysis_results.csv`: 検出結果（座標、面積、楕円パラメータなど）
- `activity_graph.png`: 活動量の時系列グラフ
- `time_config.json`: 時間設定情報
- `detection_video.avi`: 検出結果の動画（オプション）

### 時間設定
- **昼開始時刻**: 明期の開始時刻（例: 07:00）
- **夜開始時刻**: 暗期の開始時刻（例: 19:00）
- **測定開始時刻**: データ解析の基準となる開始時刻（例: 09:00:00）

### Constant Darkness モード
- 恒暗条件での実験に対応
- グラフ表示時に昼夜の区別を行わない
- 概日リズム解析に適している

## 技術的詳細

### 画像処理パイプライン
1. **ROIマスク適用**: 指定された円形領域外を黒塗り
2. **夜間判定**: 平均明度による自動判定
3. **コントラスト調整**: 夜間画像に対する自動調整
4. **Temporal Median Filter**: 背景除去（オプション）
5. **二値化**: 適応的または相対閾値による二値化
6. **輪郭検出**: OpenCVによる輪郭抽出
7. **個体選択**: 面積・位置による最適個体の選択

### 座標系の扱い
- ROI設定時の座標は元画像の座標系で保存
- プレビュー時は表示用にスケーリング
- 解析結果は元画像の座標系で出力

### パフォーマンス最適化
- マルチスレッド処理による背景作成
- プログレッシブな解析進捗表示
- メモリ効率的な画像処理

## 必要な環境
- Python 3.7以上
- OpenCV
- NumPy
- Pandas
- Matplotlib
- PIL/Pillow
- scikit-image
- tkinter

## トラブルシューティング

### よくある問題と解決方法

#### 「個体が検出されない」
- パラメータを調整（c_valueを小さく、relative_threshを大きく）
- 最小面積を小さくする
- コントラスト調整を有効にする
- ROI設定を確認する

#### 「ノイズが多く検出される」
- パラメータを調整（c_valueを大きく、block_sizeを大きく）
- 最小面積を大きくする
- バックグラウンド除去を有効にする
- Temporal Median Filterを使用する

#### 「ROI外の物体が検出される」
- ROI設定を確認し、適切な円形領域が設定されているか確認
- ROI使用チェックボックスが有効になっているか確認
- 円形マスクが正しく適用されているかプレビューで確認

#### 「夜間の検出精度が低い」
- 夜間自動コントラスト調整を有効にする
- 夜間判定閾値を調整する
- CLAHEパラメータを調整する

## 更新履歴
- v1.2: ROI円形マスク機能追加、夜間自動コントラスト調整機能追加
- v1.1: Temporal Median Filter、動画保存機能追加
- v1.0: 基本的な検出・解析機能
