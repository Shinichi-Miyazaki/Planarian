
### D. 推奨改善順序

1. **まず試すべき**（無料・簡単）:
   - 相対閾値を0.20に上げる
   - ROIを設定
   - Temporal Median Filterを使用
   - エッジ強調を試す（重み0.3）

2. **環境改善**（コスト低・効果大）:
   - 背景を白無地に変更
   - 照明の位置を調整（斜め45度から）
   - カメラ設定を固定（自動調整OFF）

3. **本格的な改善**（コスト中～高）:
   - 赤外線照明を導入
   - 拡散照明システムを構築
   - 専用容器を作成

### E. よくある問題と対策

| 問題 | 原因 | 対策 |
|------|------|------|
| 夜間に誤検出が多い | 照明が暗い | 相対閾値UP、赤外線照明導入 |
| 個体が検出されない | コントラスト不足 | エッジ強調、背景変更 |
| 検出が不安定 | 照明変動 | カメラ設定固定、照明固定 |
| 反射が多い | 光沢背景 | マット仕上げ背景に変更 |
| 影が多い | 直接照明 | 拡散照明に変更 |

### F. 画像処理 vs 環境改善

**画像処理の限界**:
- ノイズが多い画像から正確な情報を取り出すのは困難
- 処理を強くするとノイズも強調される
- 照明変動には対応しきれない

**環境改善の利点**:
- 高品質な画像を取得できれば、シンプルな処理で十分
- 安定した結果が得られる
- 後処理の負担が減る

**結論**: 
- **短期的**: 画像処理パラメータを最適化（無料）
- **中長期的**: 撮影環境を改善（低コスト・高効果）
- **最終的**: 専用システムを構築（最高品質）

# Planarian Detection System

プラナリア（または他の小動物）の自動検出・追跡システムです。画像解析により個体の位置・面積・活動量を自動で測定します。

## 主な機能

### 1. 画像解析
- **個体検出**: 暗い背景から明るい個体、または明るい背景から暗い個体を自動検出
- **形状測定**: 重心座標、面積、長軸・短軸、真円度を計算
  - エッジ強調機能を追加
  - 検出能力向上ガイドを追加
  - README作成・拡充

### 2. 検出方法

#### 二値化方式
- **relative (推奨)**: 画像の平均輝度を基準に相対的に閾値を設定
  - `relative_thresh=0.15`で平均輝度の85%を閾値とする
  - 照明条件の変動に強く、夜間の誤検出を抑制
- **adaptive**: 適応的二値化（局所的に閾値を設定）
- **fixed**: 固定閾値（非推奨）

#### 背景除去
- **Temporal Median Filter**: 複数フレームの中央値から背景を作成して除去（動きの少ないノイズ除去に有効）
- **Gaussian Blur**: ガウシアンブラーによる簡易的な背景除去

### 3. ROI（関心領域）設定
- 円形ROIを設定可能
- ROI外の領域を無視することで誤検出を削減

### 4. コントラスト調整
- 基本的なコントラスト・明度調整
- CLAHE（局所適応ヒストグラム平坦化）による夜間画像の強調

### 5. グラフ化・可視化
- 時系列グラフの自動生成（面積の変化）
- 昼夜周期の可視化
- Constant Darkness条件にも対応

## インストール

```bash
pip install -r requirements.txt
```

## 使い方

### 1. GUIの起動

```bash
python animal_detector_gui.py
```

### 2. 基本的な設定手順

1. **画像フォルダを選択**: 解析対象の画像が保存されているフォルダを指定
2. **代表画像を選択**: 昼・夜それぞれの代表的な画像を選択（パラメータ調整の確認用）
3. **パラメータ設定**:
   - 最小面積・最大面積: 検出対象のサイズ範囲（pixels²）
4. **二値化設定**:
   - メソッド: `relative`を推奨
   - 相対閾値: `0.15`が標準（夜間の誤検出を抑えるには`0.2-0.3`に上げる）
5. **プレビュー確認**: 設定を変更したら「更新」ボタンでプレビューを確認
6. **解析開始**: すべての設定が完了したら「解析開始」をクリック

### 3. 推奨パラメータ設定

#### 基本設定（昼夜共通）
```
メソッド: relative
相対閾値: 0.15 (標準) ～ 0.30 (夜間誤検出が多い場合)
最小面積: 100
最大面積: 10000
個体選択: Select Largest Particle にチェック
```

#### 夜間の誤検出対策
1. **相対閾値を上げる**: `0.20 ～ 0.30`
2. **ROI設定**: 個体が存在する領域のみに制限
3. **Temporal Median Filter**: 背景を作成して除去
4. **コントラスト調整**: CLAHE を有効化（夜間画像の強調）

#### 照明条件が安定している場合
```
メソッド: relative
相対閾値: 0.15
BG除去: False
```

#### 照明条件が変動する場合
```
メソッド: relative
相対閾値: 0.20
Temporal Median Filter: 使用
フレーム数: 100
```

### 4. パラメータの意味

#### 二値化設定
- **相対閾値 (relative_thresh)**: 
  - 値が小さいほど検出感度が高い（誤検出も増える）
  - 値が大きいほど検出が厳しくなる（夜間の誤検出を抑制）
  - 推奨範囲: 0.10 ～ 0.30
  
- **定数C (c_value)**: 
  - adaptive方式で使用
  - 値が大きいほど明るい部分が検出されにくい
  
- **ブロックサイズ (block_size)**: 
  - adaptive方式で使用
  - 奇数である必要がある
  - 大きいほど広い範囲の平均を使用

#### 面積フィルタ
- **最小面積**: これより小さいオブジェクトは無視
- **最大面積**: これより大きいオブジェクトは無視
- 単位: pixels²

#### ROI設定
- 昼の代表画像でマウスドラッグにより円形ROIを設定
- ROI外の領域は検出対象から除外

### 5. 出力ファイル

解析完了後、画像フォルダ内に以下のファイルが生成されます:

- `analysis_results.csv`: 検出結果（重心座標、面積、形状など）
- `activity_graph.png`: 時系列グラフ
- `time_config.json`: 時間設定（昼夜の開始時刻など）
- `detection_video.avi`: 検出結果の動画（動画保存を有効にした場合）

## パラメータ調整のコツ

### 1. 誤検出が多い場合
- 相対閾値を上げる（0.15 → 0.25）
- ROIを設定して検出範囲を制限
- 最小面積を大きくする

### 2. 検出できない場合
- 相対閾値を下げる（0.15 → 0.10）
- コントラスト調整を有効化
- 最小面積を小さくする

### 3. 夜間の誤検出が多い場合（重要）
- **最重要**: 相対閾値を上げる（0.20 ～ 0.30）
  - 夜間は照明が暗く、ノイズが相対的に大きく見えるため
  - 相対閾値を上げることで、明度差が小さいノイズを除外できる
- Temporal Median Filterを使用
  - 動きの少ない背景ノイズを除去
- ROIを設定
  - 個体が存在する領域のみに制限
- CLAHEを有効化しない
  - 夜間のノイズが強調されるため

### 4. 個体が複数検出される場合
- 「Select Largest Particle」にチェック
- 最小面積を大きくして小さなノイズを除外

## パラメータ設定ガイド

### relative_thresh（相対閾値）の効果
- **値が小さい（0.05 ～ 0.10）**: 
  - 検出感度が高い
  - 小さな輝度差でも検出
  - 誤検出が増える傾向
- **値が中程度（0.15 ～ 0.20）**: 
  - バランスが取れた設定
  - 標準的な使用に推奨
- **値が大きい（0.25 ～ 0.35）**: 
  - 検出が厳しくなる
  - 夜間の誤検出を抑制
  - 見逃しが増える可能性

### なぜrelative方式が夜間誤検出に強いか
1. **画像ごとに閾値が自動調整される**
   - 夜間の暗い画像では閾値も自動的に低くなる
   - 相対的な輝度差のみを検出
   
2. **相対閾値で感度を調整可能**
   - 固定閾値では夜間に過検出になりがち
   - relative方式なら閾値を上げるだけで夜間の誤検出を抑制

3. **計算式**:
   ```
   閾値 = 平均輝度 × (1 - relative_thresh)
   ```
   - 例: 平均輝度が100の場合
     - relative_thresh=0.15 → 閾値=85
     - relative_thresh=0.30 → 閾値=70
   - 夜間（平均輝度30）の場合
     - relative_thresh=0.15 → 閾値=25.5
     - relative_thresh=0.30 → 閾値=21

### methodの選び方
- **relative（推奨）**: 
  - ほとんどの場合に最適
  - 照明条件の変動に強い
  - パラメータ調整が簡単（relative_threshのみ）
  
- **adaptive**: 
  - 局所的に照明が異なる場合に有効
  - パラメータが多く調整が難しい
  - 計算コストが高い
  
- **fixed**: 
  - 照明条件が完全に一定の場合のみ
  - 一般的には非推奨

## 設定の保存・読み込み

- **設定保存**: 現在のパラメータをJSONファイルとして保存
- **設定ロード**: 保存した設定を読み込み

同じ実験条件で複数回解析を行う場合に便利です。

## トラブルシューティング

### Q: 夜間に誤検出が多い
A: 
1. 相対閾値を0.20以上に上げる
2. ROIを設定して検出範囲を制限
3. Temporal Median Filterを使用

### Q: 個体が検出されない
A:
1. 相対閾値を下げる（0.10程度）
2. 最小面積を小さくする
3. コントラスト調整を試す

### Q: 背景のノイズが検出される
A:
1. 最小面積を大きくする
2. ROIを設定
3. Temporal Median Filterを使用

### Q: 動画保存が失敗する
A:
- OpenCVのコーデック(XVID)が必要
- スケールを小さく（0.5以下）してファイルサイズを削減

## 技術的詳細

### 検出アルゴリズム
1. 前処理（オプション）:
   - ROIマスク適用
   - Temporal Median背景除去
   - コントラスト調整
2. 二値化:
   - relative方式: `threshold = mean * (1 - relative_thresh)`
   - adaptive方式: 局所的に閾値を設定
3. 輪郭検出:
   - 面積フィルタを適用
   - 最大面積または中心に最も近い個体を選択
4. 形状測定:
   - 重心、面積、長軸・短軸、真円度を計算

### relative方式の利点
- 照明条件の変動に強い（画像ごとに閾値が自動調整される）
- 夜間の誤検出を抑制（相対閾値を上げることで感度を調整可能）
- 計算が軽い

## 開発者向け情報

### ファイル構成
- `animal_detector_gui.py`: メインGUIアプリケーション
- `behavior_analysis.py`: 行動解析用スクリプト（将来の拡張用）
- `requirements.txt`: 必要なPythonパッケージ

### 主要な関数
- `binarize()`: 二値化処理
- `analyze()`: 個体検出・形状測定
- `create_temporal_median_background()`: Temporal Median背景作成
- `enhance_contrast()`: コントラスト調整

## 検出能力を上げる方法（重要）

検出精度を向上させるには、**画像処理の改善**と**画像取得環境の改善**の両方が重要です。

### A. 画像処理による改善（すぐ実装可能）

#### 1. エッジ強調（新機能）
個体の輪郭を強調して検出率を向上させます。

```
設定:
- エッジ強調: チェック
- 重み: 0.3 ～ 0.5（大きいほど輪郭が強調される）
```

**効果**:
- ぼやけた個体の輪郭が明確になる
- 背景との境界が曖昧な場合に有効
- コントラストが低い画像で特に効果的

**注意**:
- 重みを大きくしすぎるとノイズも強調される
- 夜間は慎重に使用（0.2～0.3程度）

#### 2. CLAHE（局所適応ヒストグラム平坦化）
照明ムラがある場合に有効です。

```
設定:
- CLAHE: チェック
- 制限: 2.0 ～ 3.0
```

**効果**:
- 局所的に暗い領域でも個体を検出可能
- 照明が不均一な場合に効果的

#### 3. Temporal Median Filter
動きの少ない背景ノイズを除去します。

```
設定:
- 使用: チェック
- フレーム数: 100 ～ 200
- 背景作成ボタンをクリック
```

**効果**:
- 背景の反射や汚れを除去
- 夜間の誤検出を大幅に削減

#### 4. 組み合わせ例

**標準設定（昼間・照明良好）**:
```
メソッド: relative
相対閾値: 0.15
エッジ強調: OFF
CLAHE: OFF
```

**照明が不均一な場合**:
```
メソッド: relative
相対閾値: 0.15
エッジ強調: ON（重み 0.3）
CLAHE: ON（制限 2.5）
```

**夜間・低コントラスト**:
```
メソッド: relative
相対閾値: 0.25
エッジ強調: ON（重み 0.2）
CLAHE: OFF
Temporal Median Filter: ON
```

### B. 画像取得環境の改善（最も効果的）

画像処理には限界があります。以下の環境改善により、**根本的に検出精度が向上**します。

#### 1. 照明の改善（最重要）

**推奨設定**:
- **赤外線照明の使用**: 個体に影響を与えず、24時間安定した照明
- **拡散照明**: 直接照明は避け、反射板で拡散させる
- **照度の統一**: 昼夜で照度を一定に保つ（赤外線カメラ使用時）

**照明の配置**:
```
悪い例: カメラ上部から直接照明 → 反射、影が多い
良い例: 斜め45度から拡散照明 → 均一な照度、影が少ない
最良例: リング照明またはバックライト → 最も均一
```

#### 2. 背景の改善

**推奨背景**:
- **均一な色**: 白または黒の無地背景
- **マット仕上げ**: 反射を避ける
- **個体とのコントラスト**: 個体が暗い場合は白背景、明るい場合は黒背景

**NG背景**:
- 模様がある
- 光沢がある（反射する）
- 汚れや傷が多い

#### 3. カメラ設定の最適化

**推奨設定**:
```
解像度: 640x480 以上（個体サイズに応じて）
フレームレート: 0.1 FPS（10秒に1枚）で十分
露出: 自動露出OFF、マニュアル固定
ホワイトバランス: 固定
フォーカス: マニュアルフォーカス固定
```

**重要**: 自動調整機能をすべてOFFにして、撮影条件を固定する

#### 4. 容器・環境の改善

**推奨環境**:
- 透明な容器を使用（ガラスまたはアクリル）
- 容器外側に背景板を設置
- 水の濁りを最小限に
- 気泡の混入を避ける
- 振動を避ける

#### 5. 撮影タイミング

**推奨**:
- 個体が動いていない時を狙う（フレーム間差分も検討）
- 給餌後は避ける（水の濁りのため）

### C. 効果の比較

| 改善方法 | コスト | 効果 | 難易度 |
|---------|--------|------|--------|
| 相対閾値調整 | 無料 | ★★★ | 簡単 |
| エッジ強調 | 無料 | ★★★ | 簡単 |
| CLAHE | 無料 | ★★ | 簡単 |
| Temporal Median | 無料 | ★★★★ | 簡単 |
| ROI設定 | 無料 | ★★★★ | 簡単 |
| 照明改善 | 低～中 | ★★★★★ | 中 |
| 背景改善 | 低 | ★★★★★ | 簡単 |
| カメラ設定 | 無料 | ★★★★ | 簡単 |
| 赤外線カメラ | 高 | ★★★★★ | 中～高 |
## ライセンス

（適宜追加してください）

## 更新履歴

- 2025-01-16: 
  - relative方式の二値化を実装
  - 夜間誤検出対策を強化
  - README作成

