# Excelファイルベースのバッチ解析ガイド

Excelファイルから実験条件を読み込み、複数日データの統合解析を実行する機能の使い方

---

## 📋 概要

Excelファイルに記載されたフォルダ名・測定開始日時の情報を読み込み、該当フォルダのみを自動解析します。個別フォルダ解析の完了後、複数日のデータを統合して時系列プロットと明暗期比較を自動生成します。

### 主な機能

1. **Excelファイルからのフォルダ指定**
   - `dir_name`, `start_date`, `start_time`列から実験条件を読み込み
   - 指定フォルダのみを自動検出・解析

2. **個別フォルダ解析**
   - セグメンテーション推論
   - 行動解析（移動量、不動性割合、体長）
   - 各フォルダ内に`segmentation_analysis/`を作成

3. **複数日統合解析**
   - 明期開始(12:00:00)基準で時刻を統一
   - z-score正規化による標準化
   - 時系列プロット（複数日重ね合わせ）
   - 明期 vs 暗期の比較プロット（jitter + boxplot）
   - R解析用の統合CSV出力

---

## 📝 Excelファイルのフォーマット

### 必須カラム

Excelファイルの1枚目のシートに以下のカラムが必要です：

| カラム名 | 形式 | 説明 | 例 |
|---------|------|------|-----|
| `dir_name` | 文字列 | フォルダ名（親フォルダ配下で検索） | `experiment_day1` |
| `start_date` | yyyyMMdd | 測定開始日付（8桁の数字） | `20260210` |
| `start_time` | HH:mm:ss | 測定開始時刻 | `08:00:00` |

### サンプルExcelファイル

```
| dir_name          | start_date | start_time |
|-------------------|------------|------------|
| experiment_day1   | 20260206   | 08:00:00   |
| experiment_day2   | 20260207   | 08:15:00   |
| experiment_day3   | 20260208   | 08:00:00   |
| control_day1      | 20260206   | 13:30:00   |
| control_day2      | 20260207   | 13:45:00   |
```

### 注意事項

- **測定開始が12:00:00以降の場合**: 12:00:00から測定開始までの期間は欠損値として扱われます
- フォルダが見つからない場合や画像数が閾値未満の場合はスキップされます
- 日付フォーマットは`yyyyMMdd`（例: `20260210`）で統一してください
- 時刻フォーマットは`HH:mm:ss`（例: `08:00:00`）で統一してください

---

## 🚀 使い方

### 1. GUIを起動

```powershell
cd C:\Users\Shinichi\PycharmProjects\Planarian\segmentation
python inference_analysis_gui.py
```

### 2. バッチフォルダ解析タブを選択

画面上部のタブから「バッチフォルダ解析」を選択します。

### 3. 基本設定

#### 親フォルダを選択
- 「参照」ボタンをクリック
- 実験フォルダを含む上位フォルダ（親フォルダ）を選択
- 例: `D:\Experiments\Planaria_2026\`

#### Excelファイルを選択（オプション）
- 「Excelファイル (オプション)」の「参照」ボタンをクリック
- 実験条件を記載したExcelファイルを選択
- Excel指定時は`dir_name`, `start_date`, `start_time`列が必要

#### 画像数閾値を設定
- デフォルト: 1000枚以上
- 必要に応じて変更可能

#### モデルファイルを確認
- デフォルト: `models/best_unet.pth`

### 4. フォルダを検索

「フォルダを検索」ボタンをクリックすると：

- **Excelファイル指定時**: Excelに記載されたフォルダを親フォルダ配下で検索
- **Excelファイル未指定時**: 親フォルダ配下を全走査（従来の動作）

検出が完了すると、画面下部のテーブルに結果が表示されます。

### 5. 共通時間設定

全フォルダに共通する設定：

- **昼開始**: 昼の開始時刻（デフォルト: 07:00）
- **夜開始**: 夜の開始時刻（デフォルト: 19:00）
- **間隔（分）**: 時間間隔（デフォルト: 10分）
- **動画を作成**: セグメンテーション動画を作成するか

### 6. フォルダ別時間設定の編集（オプション）

Excelから読み込んだ日時を変更したい場合：

1. テーブル内のフォルダをダブルクリック
2. 編集ダイアログで日付・時刻を修正
3. 「保存」ボタンをクリック

### 7. バッチ実行

「バッチ実行」ボタンをクリックすると、確認ダイアログが表示されます。

**処理フロー:**

1. **個別フォルダ解析**（順次実行）
   - 各フォルダに対してセグメンテーション推論と行動解析を実行
   - 各フォルダ内に`segmentation_analysis/`を作成

2. **統合解析**（2つ以上の実験がある場合のみ）
   - 複数日データを統合
   - z-score正規化
   - 統合プロット作成
   - R解析用CSV出力

### 8. 結果の確認

全ての処理が完了すると、詳細結果ウィンドウが表示されます。

---

## 📂 出力ファイル構成

### 個別フォルダの出力

各画像フォルダ内に`segmentation_analysis/`が作成されます：

```
親フォルダ/
├── experiment_day1/
│   ├── 00001.jpg
│   ├── 00002.jpg
│   ├── ...
│   └── segmentation_analysis/
│       ├── analysis_results.csv
│       ├── detailed_immobility_analysis.csv
│       ├── aggregated_immobility_analysis.csv  ← 統合解析で使用
│       ├── day_night_summary.csv
│       ├── time_config.json
│       ├── *.png（グラフ）
│       └── segmentation_video.avi（オプション）
│
├── experiment_day2/
│   └── segmentation_analysis/
│       └── ...
...
```

### 統合解析の出力

親フォルダ直下に`batch_summary/`が作成されます：

```
親フォルダ/
├── experiment_day1/
├── experiment_day2/
├── experiment_day3/
└── batch_summary/  ← 統合解析結果
    ├── timeseries_comparison.png        # 時系列プロット（3指標）
    ├── light_dark_comparison.png        # 明期 vs 暗期比較
    ├── combined_data_for_R.csv          # R解析用統合データ
    └── summary_statistics.txt           # サマリー統計
```

---

## 📊 統合解析の詳細

### z-score正規化

**理由**: 個体差や測定日間のベースライン変動を補正し、パターンの比較を容易にする

**計算方法**:
```
z-score = (x - mean) / std
```

全区間データで平均と標準偏差を計算し、各データポイントを標準化します。

### 時系列プロット

- 明期開始(12:00:00)を基準時刻(0h)として、各実験日のデータを相対時刻に変換
- 複数日のデータを異なる色で重ね合わせて表示
- 移動量、不動性割合、体長の3指標をそれぞれプロット
- 暗期の背景をグレーで表示

### 明期 vs 暗期比較

- **明期**: 12:00:00 - 24:00:00 (0h - 12h)
- **暗期**: 00:00:00 - 12:00:00 (12h - 24h)
- jitter plot（個別データポイント）+ boxplot（分布）で表示

### R解析用CSV

`combined_data_for_R.csv`には以下の情報が含まれます：

- `experiment_id`: 実験ID（日付）
- `experiment_name`: フォルダ名
- `time_bin`: 時間ビン番号
- `hours_from_light_start`: 明期開始からの経過時間（時間単位）
- `period`: 明期/暗期の区分（Light/Dark）
- `total_movement`: 移動量（生データ）
- `total_movement_zscore`: 移動量（z-score正規化）
- `immobility_ratio`: 不動性割合（生データ）
- `immobility_ratio_zscore`: 不動性割合（z-score正規化）
- `mean_body_length`: 体長（生データ）
- `mean_body_length_zscore`: 体長（z-score正規化）
- その他統計量

---

## 💡 使用例

### シナリオ: 複数日の実験データを一括解析

#### 1. Excelファイルを作成

`experiment_conditions.xlsx`:

```
| dir_name          | start_date | start_time |
|-------------------|------------|------------|
| Day1_20260206     | 20260206   | 08:00:00   |
| Day2_20260207     | 20260207   | 08:15:00   |
| Day3_20260208     | 20260208   | 07:50:00   |
| Day4_20260209     | 20260209   | 08:10:00   |
```

#### 2. GUIで設定

1. 親フォルダ: `D:\Experiments\Planaria_Feb2026\`
2. Excelファイル: `D:\experiment_conditions.xlsx`
3. 画像数閾値: 1000
4. 「フォルダを検索」→ 4フォルダ検出
5. 「バッチ実行」

#### 3. 結果

- 各Dayフォルダ内に`segmentation_analysis/`が作成
- `D:\Experiments\Planaria_Feb2026\batch_summary/`に統合解析結果が作成
- R解析用CSVで詳細な統計解析が可能

---

## ⚠️ 注意事項

### 測定開始時刻が12:00:00以降の場合

測定開始が12:00:00（明期開始）より遅い場合、12:00:00から測定開始までの期間は欠損値として扱われます。

**例**: 測定開始が13:30:00の場合
- 0.00h ～ 1.50h: 欠損値
- 1.50h ～ : 実測データ

統合プロットでは、この期間は線が途切れて表示されます。

### 処理時間

- 1フォルダあたり約10,000枚の画像の場合、CPU処理で数時間かかる場合があります
- バッチ処理は順次実行されるため、全体で長時間を要することがあります

### 既存データの上書き

- 既存の`segmentation_analysis`フォルダは上書きされます
- 既存の`batch_summary`フォルダは上書きされます

### 統合解析の実行条件

- 2つ以上の実験が成功した場合のみ統合解析が実行されます
- 1つの実験のみの場合は個別解析結果のみ出力されます

---

## 🔧 トラブルシューティング

### Excelファイルが読み込めない

**エラー**: 「Excelファイルに必要な列がありません」

**対処法**:
- Excel 1枚目のシートに`dir_name`, `start_date`, `start_time`列があるか確認
- 列名のスペルミスがないか確認

### フォルダが見つからない

**警告**: 「⚠️ フォルダが見つかりません: xxx」

**対処法**:
- 親フォルダのパスが正しいか確認
- `dir_name`がフォルダ名と完全に一致しているか確認（大文字小文字も区別）

### 日付・時刻フォーマットエラー

**エラー**: 「⚠️ 時刻フォーマットが不正」

**対処法**:
- `start_date`: `yyyyMMdd`形式（例: `20260210`）
- `start_time`: `HH:mm:ss`形式（例: `08:00:00`）
- Excelのセル書式設定を「文字列」に変更してから入力

---

## 📖 関連ドキュメント

- [BATCH_ANALYSIS_GUIDE.md](BATCH_ANALYSIS_GUIDE.md): 従来のバッチ解析ガイド
- [PATH_CONFIGURATION_GUIDE.md](PATH_CONFIGURATION_GUIDE.md): パス設定ガイド

---

## 🎯 まとめ

Excelファイルベースのバッチ解析機能により：

1. **実験条件の一元管理**: Excelで測定日時を管理
2. **自動化**: 該当フォルダのみを自動検出・解析
3. **統合解析**: 複数日データの時系列・明暗期比較を自動生成
4. **R連携**: 統合CSVでさらなる統計解析が可能

効率的なデータ解析ワークフローを実現します！

