# バッチフォルダ解析ガイド

複数の画像フォルダを一括で解析する機能の使い方

---

## 📋 概要

親フォルダ配下を自動的に走査し、指定した画像数以上のフォルダを検出して、セグメンテーション推論と行動解析を一括実行します。

### 特徴

- **自動フォルダ検出**: 親フォルダ配下を再帰的に走査して画像フォルダを自動検出
- **画像数フィルタリング**: 指定した枚数以上の画像を含むフォルダのみを対象
- **フォルダ別時間設定**: 各フォルダごとに異なる測定開始日時を個別設定可能
- **自動出力**: 各画像フォルダ内に`segmentation_analysis`フォルダを自動作成
- **エラー耐性**: 特定フォルダでエラーが発生しても他のフォルダ処理を継続
- **詳細レポート**: 全フォルダの処理結果（成功/失敗）を一覧表示

---

## 🚀 使い方

### 1. GUIを起動

```powershell
cd C:\Users\Shinichi\PycharmProjects\Planarian\segmentation
python inference_analysis_gui.py
```

### 2. バッチフォルダ解析タブを選択

画面上部のタブから「バッチフォルダ解析」を選択します。

### 3. 基本設定

#### 親フォルダを選択
- 「参照」ボタンをクリック
- 画像フォルダを含む上位フォルダ（親フォルダ）を選択
- 例: `D:\Experiments\2026_Planaria\`

#### 画像数閾値を設定
- デフォルト: 1000枚以上
- 必要に応じて変更可能（例: 500、800、1500など）

#### モデルファイルを確認
- デフォルト: `models/best_unet.pth`
- 別のモデルを使用する場合は「参照」で選択

### 4. フォルダを検索

「フォルダを検索」ボタンをクリックすると、親フォルダ配下を走査して条件に合うフォルダを検出します。

**検出条件:**
- 指定した画像数閾値以上の画像ファイル（`.png`, `.jpg`, `.jpeg`, `.bmp`, `.tif`, `.tiff`）を含むフォルダ

検出が完了すると、画面下部のテーブルに結果が表示されます。

### 5. 共通時間設定

全フォルダに共通する設定を行います：

- **昼開始**: 昼の開始時刻（デフォルト: 07:00）
- **夜開始**: 夜の開始時刻（デフォルト: 19:00）
- **間隔（分）**: 時間間隔（デフォルト: 10分）
- **動画を作成**: セグメンテーション動画を作成するか（チェックボックス）

### 6. フォルダ別時間設定

各フォルダごとに異なる測定日時を設定できます：

1. テーブル内のフォルダをダブルクリック
2. 編集ダイアログが表示される
3. **測定日付**: YYYY-MM-DD形式（例: 2026-02-09）
4. **測定開始時刻**: HH:MM:SS形式（例: 09:00:00）
5. 「保存」ボタンをクリック

**デフォルト値:**
- 測定日付: 今日の日付
- 測定開始時刻: 共通設定の値

### 7. フォルダリストの管理

検出されたフォルダリストを調整できます：

- **選択フォルダを削除**: 選択したフォルダをリストから削除
- **全て削除**: 全てのフォルダをリストから削除してやり直し

### 8. バッチ実行

「バッチ実行」ボタンをクリックすると、確認ダイアログが表示されます。

**実行内容:**
- 各フォルダに対して順次処理を実行
- 画像フォルダ内に`segmentation_analysis`というサブフォルダを作成
- セグメンテーション推論と行動解析を実行
- 既存の`segmentation_analysis`フォルダは上書きされます

**進捗表示:**
- ステータスラベル: 現在処理中のフォルダ名と進捗（例: "処理中 (3/8): experiment_day3..."）
- 進捗バー: 全体の進捗状況

### 9. 結果の確認

全ての処理が完了すると、詳細結果ウィンドウが表示されます。

**表示内容:**
- 完了フォルダ数
- 成功数・失敗数
- 各フォルダの処理結果（成功/失敗とメッセージ）

---

## 📂 出力ファイル構成

各画像フォルダ内に以下のような構成で結果が保存されます：

```
親フォルダ/
├── experiment_day1/
│   ├── 00001.jpg
│   ├── 00002.jpg
│   ├── ...
│   └── segmentation_analysis/          ← 自動作成される
│       ├── analysis_results.csv        # セグメンテーション結果
│       ├── detailed_immobility_analysis.csv  # 詳細行動解析
│       ├── aggregated_immobility_analysis.csv  # 時間ビン集約データ
│       ├── day_night_summary.csv       # 昼夜別統計
│       ├── time_config.json            # 時間設定
│       ├── immobility_over_time.png    # 不動性グラフ
│       ├── movement_over_time.png      # 移動量グラフ
│       ├── day_night_comparison.png    # 昼夜比較グラフ
│       ├── summary_report.txt          # サマリーレポート
│       └── segmentation_video.avi      # セグメンテーション動画（オプション）
│
├── experiment_day2/
│   ├── 00001.jpg
│   ├── ...
│   └── segmentation_analysis/
│       └── ...
│
└── experiment_day3/
    ├── 00001.jpg
    ├── ...
    └── segmentation_analysis/
        └── ...
```

---

## 💡 使用例

### シナリオ: 複数日の実験データを一括解析

```
実験データ構成:
D:\Experiments\Planaria_Feb2026\
├── Day1_20260206/
│   └── (10500枚の画像)
├── Day2_20260207/
│   └── (11200枚の画像)
├── Day3_20260208/
│   └── (9800枚の画像)
└── Day4_20260209/
    └── (10100枚の画像)

手順:
1. 親フォルダに "D:\Experiments\Planaria_Feb2026\" を選択
2. 画像数閾値: 1000
3. 「フォルダを検索」→ 4フォルダ検出
4. 各フォルダをダブルクリックして測定日時を設定:
   - Day1: 2026-02-06, 09:00:00
   - Day2: 2026-02-07, 09:15:00
   - Day3: 2026-02-08, 08:45:00
   - Day4: 2026-02-09, 09:10:00
5. 「バッチ実行」→ 4フォルダを自動処理

結果:
各Dayフォルダ内に segmentation_analysis/ が作成され、
それぞれの測定日時に基づいた解析結果が保存される
```

---

## ⚠️ 注意事項

### 処理時間
- 1フォルダあたり約10,000枚の画像の場合、CPU処理で数時間かかる場合があります
- 複数フォルダのバッチ処理は順次実行されるため、全体で長時間を要することがあります
- 処理中はPCをスリープモードにしないでください

### 既存データの上書き
- 既存の`segmentation_analysis`フォルダは**上書き**されます
- 重要なデータがある場合は事前にバックアップしてください

### エラー処理
- 特定のフォルダで処理に失敗しても、他のフォルダの処理は継続されます
- 失敗したフォルダは結果ウィンドウで確認できます
- エラーの詳細はコンソール出力にも記録されます

### メモリ使用量
- 大量の画像を含むフォルダを複数処理する場合、メモリ不足に注意してください
- 問題が発生する場合は、フォルダを分割して実行することを推奨します

---

## 🔧 トラブルシューティング

### フォルダが検出されない

**原因:**
- 画像数が閾値未満
- 対応する画像拡張子のファイルがない

**対処:**
- 画像数閾値を下げる
- フォルダ内の画像ファイルを確認（`.png`, `.jpg`など）

### 処理が途中で止まる

**原因:**
- モデルファイルが見つからない
- 出力フォルダの書き込み権限がない
- メモリ不足

**対処:**
- モデルファイルのパスを確認
- フォルダの書き込み権限を確認
- 他のアプリケーションを閉じてメモリを解放

### 日付・時刻が保存できない

**原因:**
- フォーマットが正しくない

**対処:**
- 日付: YYYY-MM-DD形式（例: 2026-02-09）
- 時刻: HH:MM:SS形式（例: 09:00:00）
- 月日は必ず2桁で入力

---

## 📚 関連ドキュメント

- [メインREADME](../README.md) - セグメンテーションシステム全体の使い方
- [Google Colab学習ガイド](COLAB_TRAINING_GUIDE.md) - モデルの学習方法
- [ONNX Runtime GPU推論ガイド](../ONNX_RUNTIME_GUIDE.md) - GPU推論による高速化

---

## 🎯 まとめ

バッチフォルダ解析機能を使うと：

✅ 複数日の実験データを一括処理
✅ 各日の測定時間が異なっていても個別設定可能
✅ 自動的に結果フォルダを作成・整理
✅ エラーが発生しても他のフォルダ処理は継続
✅ 処理結果を一覧で確認可能

**手作業での繰り返し実行が不要になり、大幅な時間短縮が可能です！**

